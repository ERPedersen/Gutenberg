<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BookDAOMySQL.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gutenberg</a> &gt; <a href="index.source.html" class="el_package">main.dao</a> &gt; <span class="el_source">BookDAOMySQL.java</span></div><h1>BookDAOMySQL.java</h1><pre class="source lang-java linenums">package main.dao;

import main.dto.Author;
import main.dto.Book;
import main.dto.Location;
import main.exception.ConnectionAlreadyClosedException;
import main.util.DBConnectorMySQL;
import main.util.IDBConnectorMySQL;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

public class BookDAOMySQL implements IBookDAO {

	private IDBConnectorMySQL connector;

	/**
	 * Default constructor.
	 */
<span class="fc" id="L22">	public BookDAOMySQL() {</span>
<span class="fc" id="L23">		connector = new DBConnectorMySQL();</span>
<span class="fc" id="L24">	}</span>

	/**
	 * Constructor with dependency injection.
	 *
	 * @param connector IDBConnectorMySQL The connector to the MYSQL database.
	 */
<span class="fc" id="L31">	public BookDAOMySQL(IDBConnectorMySQL connector) {</span>
<span class="fc" id="L32">		this.connector = connector;</span>
<span class="fc" id="L33">	}</span>

	/**
	 * Returns a List of books from the MYSQL database which have the location of a latitude and longitude mentioned.
	 *
	 * @param latitude  Double the latitude of the location.
	 * @param longitude Double the longitude of the location.
	 * @param radius Int The radius the locations are found from.
	 * @return List of books The list of books where the location is mentioned.
	 */
	@Override
	public List&lt;Book&gt; getBooksFromLatLong(double latitude, double longitude, int radius) throws ConnectionAlreadyClosedException {
<span class="nc" id="L45">		List&lt;Book&gt; books = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L46">		String queryString = &quot;&quot; +</span>
                &quot;SELECT b.b_id, b.title, b.text, a.a_id, a.name, l1.l_id, l1.latitude, l1.longitude, l1.name &quot; +
                &quot;FROM book b &quot; +
                &quot;JOIN author_book ab ON b.b_id = ab.b_id &quot; +
                &quot;JOIN author a ON ab.a_id = a.a_id &quot; +
                &quot;JOIN book_location bl ON b.b_id = bl.b_id &quot; +
                &quot;JOIN location l1 ON bl.l_id = l1.l_id &quot; +
                &quot;WHERE l1.l_id IN(&quot; +
                    &quot;SELECT l2.l_id &quot; +
                    &quot;FROM location l2 &quot; +
                    &quot;WHERE(&quot; +
                        &quot;6371 * acos(&quot; +
                        &quot;cos(radians(?)) &quot; +
                        &quot;* cos(radians(l2.latitude)) &quot; +
                        &quot;* cos(radians(l2.longitude) - radians(?)) &quot; +
                        &quot;+ sin ( radians(?) ) &quot; +
                        &quot;* sin(radians( l2.latitude ))&quot; +
                    &quot;)) &lt; ?&quot; +
                &quot;);&quot;;

		try {
<span class="nc" id="L67">			Connection con = connector.getConnection();</span>
<span class="nc" id="L68">			PreparedStatement statement = con.prepareStatement(queryString);</span>
<span class="nc" id="L69">            statement.setDouble(1,latitude);</span>
<span class="nc" id="L70">            statement.setDouble(2, longitude);</span>
<span class="nc" id="L71">            statement.setDouble(3, latitude);</span>
<span class="nc" id="L72">            statement.setInt(4, radius);</span>

<span class="nc" id="L74">            ResultSet resultSet = statement.executeQuery();</span>

<span class="nc" id="L76">            Book book = null;</span>
<span class="nc" id="L77">            long currentBookUID = 0L;</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">            while (resultSet.next()) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                if (currentBookUID != resultSet.getLong(1)) {</span>
<span class="nc" id="L81">                    currentBookUID = resultSet.getLong(1);</span>
<span class="nc" id="L82">                    book = new Book(</span>
<span class="nc" id="L83">                            resultSet.getLong(1),</span>
<span class="nc" id="L84">                            resultSet.getString(2),</span>
                            new ArrayList&lt;&gt;(),
                            new ArrayList&lt;&gt;(),
                            new ArrayList&lt;&gt;(),
<span class="nc" id="L88">                            resultSet.getString(3)</span>
                    );
<span class="nc" id="L90">                    books.add(book);</span>
<span class="nc" id="L91">                    book.addAuthor(new Author(resultSet.getLong(4), resultSet.getString(5)));</span>
                }

<span class="nc bnc" id="L94" title="All 2 branches missed.">                if (book != null) {</span>
<span class="nc" id="L95">                    book.addLocationWithinRadius(new Location(</span>
<span class="nc" id="L96">                            resultSet.getLong(6),</span>
<span class="nc" id="L97">                            resultSet.getDouble(7),</span>
<span class="nc" id="L98">                            resultSet.getDouble(8),</span>
<span class="nc" id="L99">                            resultSet.getString(9)</span>
                    ));
                }
            }
<span class="nc" id="L103">		} catch (SQLException | ClassNotFoundException e) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (Objects.equals(System.getenv(&quot;PROCESS_ENV&quot;), &quot;prod&quot;)) {</span>
<span class="nc" id="L105">                return null;</span>
            } else {
<span class="nc" id="L107">                e.printStackTrace();</span>
            }
		} finally {
<span class="nc" id="L110">			connector.closeConnection();</span>
<span class="nc" id="L111">		}</span>
<span class="nc" id="L112">		return books;</span>
	}

	/**
	 * Returns a List of books from the MYSQL database which is written by the author.
	 *
	 * @param name String The name of the author who has written the books.
	 * @return List of books which are written by the author.
	 */
	@Override
	public List&lt;Book&gt; getBooksAndCitiesFromAuthor(String name) throws ConnectionAlreadyClosedException {
<span class="nc" id="L123">		List&lt;Book&gt; books = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L124">		String queryString =</span>
				&quot;SELECT DISTINCT b.b_id, b.title, b.text, a.a_id, l.l_id, l.latitude, l.longitude, l.name &quot; +
						&quot;FROM book b &quot; +
						&quot;JOIN book_location bl ON b.b_id = bl.b_id &quot; +
						&quot;JOIN location l ON bl.l_id = l.l_id &quot; +
						&quot;JOIN author_book ab ON b.b_id = ab.b_id &quot; +
						&quot;JOIN author a ON ab.a_id = a.a_id &quot; +
						&quot;WHERE a.name = ?&quot; +
						&quot;ORDER BY b.b_id;&quot;;
		try {
<span class="nc" id="L134">			Connection con = connector.getConnection();</span>
<span class="nc" id="L135">			PreparedStatement statement = con.prepareStatement(queryString);</span>
<span class="nc" id="L136">			statement.setString(1, name);</span>
<span class="nc" id="L137">            ResultSet resultSet = statement.executeQuery();</span>

<span class="nc" id="L139">			Book book = null;</span>
<span class="nc" id="L140">			long currentBookUID = 0L;</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">				if (currentBookUID != resultSet.getLong(1)) {</span>
<span class="nc" id="L145">					currentBookUID = resultSet.getLong(1);</span>

<span class="nc" id="L147">					book = new Book(</span>
<span class="nc" id="L148">							resultSet.getLong(1),</span>
<span class="nc" id="L149">							resultSet.getString(2),</span>
							new ArrayList&lt;&gt;(),
							new ArrayList&lt;&gt;(),
<span class="nc" id="L152">							resultSet.getString(3)</span>
					);
<span class="nc" id="L154">					books.add(book);</span>
<span class="nc" id="L155">					book.addAuthor(new Author(resultSet.getLong(4), name));</span>
				}

<span class="nc bnc" id="L158" title="All 2 branches missed.">				if (book != null) {</span>
<span class="nc" id="L159">					book.addLocation(new Location(</span>
<span class="nc" id="L160">							resultSet.getLong(5),</span>
<span class="nc" id="L161">							resultSet.getDouble(6),</span>
<span class="nc" id="L162">							resultSet.getDouble(7),</span>
<span class="nc" id="L163">							resultSet.getString(8)</span>
					));
				}
			}
<span class="nc" id="L167">		} catch (SQLException | ClassNotFoundException e) {</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">			if (Objects.equals(System.getenv(&quot;PROCESS_ENV&quot;), &quot;prod&quot;)) {</span>
<span class="nc" id="L169">				return null;</span>
			} else {
<span class="nc" id="L171">				e.printStackTrace();</span>
			}
		} finally {
<span class="nc" id="L174">		    connector.closeConnection();</span>
<span class="nc" id="L175">        }</span>

<span class="nc" id="L177">		return books;</span>
	}

	/**
	 * Returns a List of books from the MYSQL database where the cities mentioned in a Book is mentioned.
	 *
	 * @param title String The title of the book.
	 * @return List of books with locations.
	 */
	@Override
	public List&lt;Location&gt; getCitiesFromBook(String title) throws ConnectionAlreadyClosedException {
<span class="nc" id="L188">		List&lt;Location&gt; locations = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L189">		String queryString =</span>
				&quot;SELECT * FROM location l &quot; +
						&quot;JOIN book_location bl ON l.l_id = bl.l_id &quot; +
						&quot;JOIN book b ON bl.b_id = b.b_id &quot; +
						&quot;WHERE MATCH(b.title) AGAINST(?) AND b.title LIKE ?;&quot;;

		try {
<span class="nc" id="L196">			Connection con = connector.getConnection();</span>
<span class="nc" id="L197">			PreparedStatement preparedStatement = con.prepareStatement(queryString);</span>
<span class="nc" id="L198">			preparedStatement.setString(1, title);</span>
<span class="nc" id="L199">			preparedStatement.setString(2, title);</span>
<span class="nc" id="L200">			ResultSet resultSet = preparedStatement.executeQuery();</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L203">				Location location = new Location(</span>
<span class="nc" id="L204">						resultSet.getLong(1),</span>
<span class="nc" id="L205">						resultSet.getDouble(2),</span>
<span class="nc" id="L206">						resultSet.getDouble(3),</span>
<span class="nc" id="L207">						resultSet.getString(4)</span>
				);
<span class="nc" id="L209">				locations.add(location);</span>
<span class="nc" id="L210">			}</span>

<span class="nc" id="L212">		} catch (SQLException | ClassNotFoundException e) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (Objects.equals(System.getenv(&quot;PROCESS_ENV&quot;), &quot;prod&quot;)) {</span>
<span class="nc" id="L214">                return null;</span>
            } else {
<span class="nc" id="L216">                e.printStackTrace();</span>
            }
		} finally {
<span class="nc" id="L219">		    connector.closeConnection();</span>
<span class="nc" id="L220">        }</span>
<span class="nc" id="L221">        return locations;</span>
	}

	/**
	 * Returns a List of books from the MYSQL database which has a location mentioned somewhere in the book.
	 *
	 * @param name String the name of the location that is mentioned in the books.
	 * @return List of books The books where the location is mentioned.
	 */
	@Override
	public List&lt;Book&gt; getAuthorsAndBooksFromCity(String name) throws ConnectionAlreadyClosedException {
<span class="nc" id="L232">        List&lt;Book&gt; books = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L233">	    String queryString = &quot;&quot; +</span>
                &quot;SELECT b.b_id, b.title, b.text, a.a_id, a.name &quot; +
                &quot;FROM book b &quot; +
                &quot;JOIN author_book ab ON b.b_id = ab.b_id &quot; +
                &quot;JOIN author a ON ab.a_id = a.a_id &quot; +
                &quot;JOIN book_location bl ON b.b_id = bl.b_id &quot; +
                &quot;JOIN location l ON bl.l_id = l.l_id &quot; +
                &quot;WHERE l.name = ?;&quot;;


<span class="nc" id="L243">        Connection con = null;</span>
        try {
<span class="nc" id="L245">            con = connector.getConnection();</span>
<span class="nc" id="L246">            PreparedStatement statement = con.prepareStatement(queryString);</span>
<span class="nc" id="L247">            statement.setString(1, name);</span>
<span class="nc" id="L248">            ResultSet resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">            while (resultSet.next()) {</span>
<span class="nc" id="L251">                Book book = new Book(</span>
<span class="nc" id="L252">                        resultSet.getLong(1),</span>
<span class="nc" id="L253">                        resultSet.getString(2),</span>
                        new ArrayList&lt;&gt;(),
                        new ArrayList&lt;&gt;(),
<span class="nc" id="L256">                        resultSet.getString(3)</span>
                );
<span class="nc" id="L258">                book.addAuthor(new Author(</span>
<span class="nc" id="L259">                        resultSet.getLong(4),</span>
<span class="nc" id="L260">                        resultSet.getString(5)</span>
                ));
<span class="nc" id="L262">                books.add(book);</span>
<span class="nc" id="L263">            }</span>
<span class="nc" id="L264">        } catch (SQLException | ClassNotFoundException e) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (Objects.equals(System.getenv(&quot;PROCESS_ENV&quot;), &quot;prod&quot;)) {</span>
<span class="nc" id="L266">                return null;</span>
            } else {
<span class="nc" id="L268">                e.printStackTrace();</span>
            }
        } finally {
<span class="nc" id="L271">            connector.closeConnection();</span>
<span class="nc" id="L272">        }</span>
<span class="nc" id="L273">        return books;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>